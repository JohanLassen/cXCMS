<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cXCMS">
<title>Tutorial • cXCMS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial">
<meta property="og:description" content="cXCMS">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cXCMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/HPC_workflow.html">HPC_workflow</a>
    <a class="dropdown-item" href="../articles/Tutorial.html">Tutorial</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tutorial</h1>
            
      
      
      <div class="d-none name"><code>Tutorial.Rmd</code></div>
    </div>

    
    
<p><code>#{r, echo=FALSE, warning=FALSE, message=FALSE} library(cXCMS) library(xcms) library(msdata) library(MsExperiment) library(readr) library(dplyr) library(tidyr) library(tibble)</code></p>
<p>The functions of this package are meant for large data sets compared
to the computer at hand. This means that all of the functions takes the
file path as input and outputs another file, which is saved to your SSD.
Hence, the computational demands are lifted off the RAM (on PCs) and for
High Performance Computing parallelization becomes feasible.</p>
<div class="section level2">
<h2 id="running-the-workflow-on-2-files">Running the workflow on 2 files<a class="anchor" aria-label="anchor" href="#running-the-workflow-on-2-files"></a>
</h2>
<div class="section level3">
<h3 id="peak-identification">Peak Identification<a class="anchor" aria-label="anchor" href="#peak-identification"></a>
</h3>
</div>
<div class="section level3">
<h3 id="defining-the-mzml-files-of-our-experiment-from-msdata-package">1. Defining the mzML files of our experiment (from msdata
package)<a class="anchor" aria-label="anchor" href="#defining-the-mzml-files-of-our-experiment-from-msdata-package"></a>
</h3>
<p><code>#{r} data_files &lt;- dir(system.file("sciex", package = "msdata"), full.names = TRUE) data_files</code></p>
<p>On your system, you might want something like this:</p>
<pre><code><span><span class="va">data_folder</span> <span class="op">&lt;-</span> <span class="st">"~/path/to/experiment"</span></span>
<span><span class="va">data_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">data_folder</span>, recursive<span class="op">=</span><span class="cn">TRUE</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="setting-output-files">2. Setting output files<a class="anchor" aria-label="anchor" href="#setting-output-files"></a>
</h3>
<p>note that it is strongly advised to use .rds as file suffix although
all names should work ```#{r} # Set temporary directlory (deleted after
session)</p>
<p>tmp_dir &lt;- “./tmp” #tempdir()</p>
<p>peak_directory &lt;- paste0(tmp_dir, “/peak_picked”)
dir.create(peak_directory, recursive = TRUE, showWarnings = FALSE)</p>
<p>peak_files &lt;- paste0(peak_directory, gsub(“.*/“,”/“, data_files))
peak_files &lt;- gsub(”.mzML”, “.rds”, peak_files) peak_files &lt;-
gsub(“-”, “_“, peak_files)</p>
<p>peak_files</p>
<pre><code>
## 3. Running peak picking on one file at a time

```#{r}

# Set the peak picking parameters
cwp &lt;- CentWaveParam()

for (i in seq_along(data_files)){
  input  &lt;- data_files[i]
  output &lt;- peak_files[i]
  
  # if file exists continue
  if (file.exists(output)) next
  cXCMS::cFindChromPeaksStep1(input = input, output = output, cwp = cwp)
}
</code></pre>
</div>
<div class="section level3">
<h3 id="merging-peak-picked-files-prior-to-peak-grouping">4. Merging peak picked files prior to peak grouping<a class="anchor" aria-label="anchor" href="#merging-peak-picked-files-prior-to-peak-grouping"></a>
</h3>
<p>This step has been highly optimized compared to previous methods,
reducing running time from nlog(n) to n. In practice this does not
matter for less than 1000 samples, but in the range of 5000-10000
samples we go from days to hours in processing time. In the +10000
sample range the old method was not viable at all. This function uses
the exact same function as the original method but uses a workaround to
avoid redundant checks.</p>
<p>```#{r}</p>
<p>output_peak_identified &lt;- paste0(tmp_dir,
“/peak_picked_dataset.rds”) cFindChromPeaksStep2(inputs = peak_files,
output = output_peak_identified)</p>
<pre><code>
## Grouping 1

```#{r}

msobject &lt;- readr::read_rds(output_peak_identified)
pdp      &lt;- xcms::PeakDensityParam(sampleGroups = msobject@phenoData@data$group)
msobject &lt;- groupChromPeaks(msobject, pdp)
</code></pre>
</div>
<div class="section level3">
<h3 id="alignment">Alignment<a class="anchor" aria-label="anchor" href="#alignment"></a>
</h3>
<p><code>#{r} pgp      &lt;- xcms::PeakGroupsParam() msobject &lt;- adjustRtime(msobject, pgp)</code></p>
</div>
<div class="section level3">
<h3 id="grouping-2">Grouping 2<a class="anchor" aria-label="anchor" href="#grouping-2"></a>
</h3>
<p>```#{r} pdp &lt;- xcms::PeakDensityParam(sampleGroups = <a href="mailto:msobject@phenoData" class="email">msobject@phenoData</a><span class="citation">@data$group</span>) msobject &lt;-
groupChromPeaks(msobject, pdp)</p>
<p>output_integration_ready &lt;- paste0(tmp_dir,
“/integration_ready.rds”) readr::write_rds(msobject,
output_integration_ready)</p>
<pre><code>
## Integration
This is the most memory consuming step in the analysis. Both in the original xcms and this HPC optimized version.

```#{r}
fcp           &lt;- FillChromPeaksParam(expandMz = 0, expandRt = 0)
output_step1  &lt;- paste0(tmp_dir, "/integration_package.rds")
prepared_data &lt;- cXCMS::cFillChromPeaksStep1(input = output_integration_ready, fcp = fcp, output = output_step1)</code></pre>
<div class="section level4">
<h4 id="extracting-peaks-from-the-spectras">Extracting peaks from the spectras<a class="anchor" aria-label="anchor" href="#extracting-peaks-from-the-spectras"></a>
</h4>
<p>This is the memory intensive step. Beware that it will always rerun
all files as the peaks depend on previous steps ```#{r} # Change subdir
from peak_picked to integrated for the output files (n=sample size) of
cFillChromPeaksStep2 step integration_files &lt;- gsub(“peak_picked”,
“integrated”, peak_files)</p>
<p>for (i in seq_along(integration_files)){ cFillChromPeaksStep2(input =
output_step1, output = integration_files[i], index = i) }</p>
<pre><code>
```#{r}
output &lt;- paste0(tmp_dir, "/preprocessing_output.rds")
cFillChromPeaksStep3(inputFromStep1 = output_step1, inputFromStep2 = integration_files, output = output)</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="output-of-preprocessing">Output of preprocessing<a class="anchor" aria-label="anchor" href="#output-of-preprocessing"></a>
</h3>
<p>```#{r}</p>
<p>ms_preprocessed &lt;- read_rds(output) feature_name &lt;-
xcms::featureDefinitions(ms_preprocessed) |&gt; as_tibble() |&gt;
mutate(feature_name = paste0(“M”, round(mzmed), “T”, round(rtmed)),
feature_name = make.unique(feature_name)) |&gt; pull(feature_name)</p>
<p>feature_values &lt;- xcms::featureValues(ms_preprocessed) |&gt;
as_tibble() |&gt; mutate(feature_name = feature_name) |&gt;
pivot_longer(cols = -feature_name) |&gt; pivot_wider(names_from =
feature_name, values_from = value)</p>
<p>head(feature_values) ```</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
