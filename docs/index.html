<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="The workflow makes the peak picking and the peak integration parallel to (1) reduce memory consumption and (2) improve support for multi-node high performance cluster processing. The first achievement benefits both local computing and HPC, while the second achievement allows exensive parallelization on clusters.">
<title>An xcms wrapper package for high performance computation (HPC) cluster worfklows • cXCMS</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="An xcms wrapper package for high performance computation (HPC) cluster worfklows">
<meta property="og:description" content="The workflow makes the peak picking and the peak integration parallel to (1) reduce memory consumption and (2) improve support for multi-node high performance cluster processing. The first achievement benefits both local computing and HPC, while the second achievement allows exensive parallelization on clusters.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">cXCMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/Tutorial.html">Run Locally</a>
    <a class="dropdown-item" href="articles/HPC_workflow.html">HPC Workflow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="cxcms">cXCMS<a class="anchor" aria-label="anchor" href="#cxcms"></a>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>The goal of cXCMS is to provide the framework for efficient high performance computing (HPC) untargeted LCMS data pre-processing. Also, the package memory optimizes the workflow in laptops environments (MacOS or Windows), allowing preprocessing of larger sample sizes on small PCs. The source code has been used for the project <a href="%5Chttps://doi.org/10.1111/acel.13813" class="external-link">Large-Scale metabolomics: Predicting biological age using 10,133 routine untargeted LC-MS measurements</a>.</p>
<p>Important notes about the package: 0. The preprocessing only works on MS1 data. If MS2 data are needed use regular xcms. 1. cXCMS reduces memory(ram) by processing files in parallel and/or sequentially. 2. Already peak called files do not have to be recalled, if new data are added. 3. The CPU time is actually (slightly) worse than xcms as files must be read and saved to disk. 4. To fully exploit the parallel functionality, use computional workflows (e.g., snakemake or gwf). 5. New peak picking softwares are continously published and we would like to refer to MZmine and OpenMS as they are faster per file (but haven’t been tested on large-scale untargeted data)</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>You can install the development version of cXCMS from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"johanLassen/cXCMS"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>The cluster xcms package is dependent on the regular xcms package. We aim to make as few changes as possible to ease the use and maintenance of the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://johanlassen.github.io/cXCMS/">cXCMS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sneumann/xcms" class="external-link">xcms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<p>Here’s the idea behind the package: The workflow makes the peak picking and the peak integration parallel to (1) reduce memory consumption and (2) improve support for multi-node high performance cluster processing. The first achievement benefits all workflows by lowering memory requirements, while the second achievement allows parallelization. All of the processes are orchestrated by a simple metadata data frame that we will describe below.</p>
<div class="section level5">
<h5 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h5>
<figure><img src="./images/workflow.png" alt="workflow"><figcaption aria-hidden="true">
workflow
</figcaption></figure>
</div>
</div>
</div>
<div class="section level1">
<h1 id="running-the-workflow-on-2-files">Running the workflow on 2 files<a class="anchor" aria-label="anchor" href="#running-the-workflow-on-2-files"></a>
</h1>
<div class="section level2">
<h2 id="peak-identification">Peak Identification<a class="anchor" aria-label="anchor" href="#peak-identification"></a>
</h2>
</div>
<div class="section level2">
<h2 id="id_1-defining-the-mzml-files-of-our-experiment-from-msdata-package">1. Defining the mzML files of our experiment (from msdata package)<a class="anchor" aria-label="anchor" href="#id_1-defining-the-mzml-files-of-our-experiment-from-msdata-package"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">data_files</span></span>
<span><span class="co">#&gt; [1] "/home/johan/R/x86_64-pc-linux-gnu-library/4.3/msdata/sciex/20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">#&gt; [2] "/home/johan/R/x86_64-pc-linux-gnu-library/4.3/msdata/sciex/20171016_POOL_POS_3_105-134.mzML"</span></span></code></pre></div>
<p>On your system, you might want something like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>data_folder <span class="ot">&lt;-</span> <span class="st">"~/path/to/experiment"</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>data_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_folder, <span class="at">recursive=</span><span class="cn">TRUE</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_2-setting-output-files">2. Setting output files<a class="anchor" aria-label="anchor" href="#id_2-setting-output-files"></a>
</h2>
<p>note that it is strongly advised to use .rds as file suffix although all names should work</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peak_directory</span> <span class="op">&lt;-</span> <span class="st">"./tmp/peak_picked"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">peak_directory</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peak_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">peak_directory</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*/"</span>, <span class="st">"/"</span>, <span class="va">data_files</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">peak_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".mzML"</span>, <span class="st">".rds"</span>, <span class="va">peak_files</span><span class="op">)</span></span>
<span><span class="va">peak_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="st">"_"</span>, <span class="va">peak_files</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peak_files</span></span>
<span><span class="co">#&gt; [1] "./tmp/peak_picked/20171016_POOL_POS_1_105_134.rds"</span></span>
<span><span class="co">#&gt; [2] "./tmp/peak_picked/20171016_POOL_POS_3_105_134.rds"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_3-running-peak-picking-on-one-file-at-a-time">3. Running peak picking on one file at a time<a class="anchor" aria-label="anchor" href="#id_3-running-peak-picking-on-one-file-at-a-time"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Set the peak picking parameters</span></span>
<span><span class="va">cwp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks-centWave.html" class="external-link">CentWaveParam</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">data_files</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">input</span>  <span class="op">&lt;-</span> <span class="va">data_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="va">peak_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># if file exists continue</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span> <span class="kw">next</span></span>
<span>  </span>
<span>  <span class="fu">cXCMS</span><span class="fu">::</span><span class="fu"><a href="reference/cFindChromPeaksStep1.html">cFindChromPeaksStep1</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">input</span>, output <span class="op">=</span> <span class="va">output</span>, cwp <span class="op">=</span> <span class="va">cwp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning in cXCMS::cFindChromPeaksStep1(input = input, output = output, cwp = cwp): No groups provided (Experimental groups). Using random group assignment</span></span>
<span><span class="co">#&gt; Warning in .local(object, param, ...): Your data appears to be not centroided!</span></span>
<span><span class="co">#&gt; CentWave works best on data in centroid mode.</span></span>
<span><span class="co">#&gt; Warning in cXCMS::cFindChromPeaksStep1(input = input, output = output, cwp = cwp): No groups provided (Experimental groups). Using random group assignment</span></span>
<span><span class="co">#&gt; Warning in .local(object, param, ...): Your data appears to be not centroided!</span></span>
<span><span class="co">#&gt; CentWave works best on data in centroid mode.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_4-merging-peak-picked-files-prior-to-peak-grouping">4. Merging peak picked files prior to peak grouping<a class="anchor" aria-label="anchor" href="#id_4-merging-peak-picked-files-prior-to-peak-grouping"></a>
</h2>
<p>This step has been highly optimized compared to previous methods, reducing running time from nlog(n) to n. In practice this does not matter for less than 1000 samples, but in the range of 5000-10000 samples we go from days to hours in processing time. In the +10000 sample range the old method was not viable at all. This function uses the exact same function as the original method but uses a workaround to avoid redundant checks.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">output_peak_identified</span> <span class="op">&lt;-</span> <span class="st">"./tmp/peak_picked_dataset.rds"</span></span>
<span><span class="fu"><a href="reference/cFindChromPeaksStep2.html">cFindChromPeaksStep2</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">peak_files</span>, output <span class="op">=</span> <span class="va">output_peak_identified</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grouping-1">Grouping 1<a class="anchor" aria-label="anchor" href="#grouping-1"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">msobject</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="va">output_peak_identified</span><span class="op">)</span></span>
<span><span class="va">pdp</span>      <span class="op">&lt;-</span> <span class="fu">xcms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">PeakDensityParam</a></span><span class="op">(</span>sampleGroups <span class="op">=</span> <span class="va">msobject</span><span class="op">@</span><span class="va">phenoData</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span>
<span><span class="va">msobject</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">groupChromPeaks</a></span><span class="op">(</span><span class="va">msobject</span>, <span class="va">pdp</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="alignment">Alignment<a class="anchor" aria-label="anchor" href="#alignment"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pgp</span>      <span class="op">&lt;-</span> <span class="fu">xcms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">PeakGroupsParam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">msobject</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/adjustRtime.html">adjustRtime</a></span><span class="op">(</span><span class="va">msobject</span>, <span class="va">pgp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Performing retention time correction using 10 peak groups.</span></span>
<span><span class="co">#&gt; Warning in do_adjustRtime_peakGroups(chromPeaks(object, msLevel = msLevel), :</span></span>
<span><span class="co">#&gt; Span too small for 'loess' and the available number of peak groups, resetting</span></span>
<span><span class="co">#&gt; to 0.4</span></span>
<span><span class="co">#&gt; Applying retention time adjustment to the identified chromatographic peaks ...</span></span>
<span><span class="co">#&gt; OK</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grouping-2">Grouping 2<a class="anchor" aria-label="anchor" href="#grouping-2"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp</span>      <span class="op">&lt;-</span> <span class="fu">xcms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">PeakDensityParam</a></span><span class="op">(</span>sampleGroups <span class="op">=</span> <span class="va">msobject</span><span class="op">@</span><span class="va">phenoData</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span>
<span><span class="va">msobject</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">groupChromPeaks</a></span><span class="op">(</span><span class="va">msobject</span>, <span class="va">pdp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output_integration_ready</span> <span class="op">&lt;-</span> <span class="st">"./tmp/integration_ready.rds"</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">msobject</span>, <span class="va">output_integration_ready</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="integration">Integration<a class="anchor" aria-label="anchor" href="#integration"></a>
</h2>
<p>This is the most memory consuming step in the analysis. Both in the original xcms and this HPC optimized version.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fcp</span>           <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/fillChromPeaks.html" class="external-link">FillChromPeaksParam</a></span><span class="op">(</span>expandMz <span class="op">=</span> <span class="fl">0</span>, expandRt <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">output_step1</span>  <span class="op">&lt;-</span> <span class="st">"./tmp/integration_package.rds"</span></span>
<span><span class="va">prepared_data</span> <span class="op">&lt;-</span> <span class="fu">cXCMS</span><span class="fu">::</span><span class="fu"><a href="reference/cFillChromPeaksStep1.html">cFillChromPeaksStep1</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">output_integration_ready</span>, fcp <span class="op">=</span> <span class="va">fcp</span>, output <span class="op">=</span> <span class="va">output_step1</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="extracting-peaks-from-the-spectras">Extracting peaks from the spectras<a class="anchor" aria-label="anchor" href="#extracting-peaks-from-the-spectras"></a>
</h3>
<p>This is the memory intensive step. Beware that it will always rerun all files as the peaks depend on previous steps</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change subdir from peak_picked to integrated for the output files (n=sample size) of cFillChromPeaksStep2 step</span></span>
<span><span class="va">integration_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"peak_picked"</span>, <span class="st">"integrated"</span>, <span class="va">peak_files</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">integration_files</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="reference/cFillChromPeaksStep2.html">cFillChromPeaksStep2</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">output_step1</span>, output <span class="op">=</span> <span class="va">integration_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, index <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Requesting 3 peaks from 20171016_POOL_POS_1_105-134.mzML ... got 3.</span></span>
<span><span class="co">#&gt; Requesting 5 peaks from 20171016_POOL_POS_3_105-134.mzML ... got 5.</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">&lt;-</span> <span class="st">"./tmp/preprocessing_output.rds"</span></span>
<span><span class="fu"><a href="reference/cFillChromPeaksStep3.html">cFillChromPeaksStep3</a></span><span class="op">(</span>inputFromStep1 <span class="op">=</span> <span class="va">output_step1</span>, inputFromStep2 <span class="op">=</span> <span class="va">integration_files</span>, output <span class="op">=</span> <span class="va">output</span><span class="op">)</span></span>
<span><span class="co">#&gt; Object of class:  FillChromPeaksParam </span></span>
<span><span class="co">#&gt;  Parameters:</span></span>
<span><span class="co">#&gt;  - expandMz: [1] 0</span></span>
<span><span class="co">#&gt;  - expandRt: [1] 0</span></span>
<span><span class="co">#&gt;  - ppm: [1] 0</span></span>
<span><span class="co">#&gt;  - fixedMz: [1] 0</span></span>
<span><span class="co">#&gt;  - fixedRt: [1] 0</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="output-of-preprocessing">Output of preprocessing<a class="anchor" aria-label="anchor" href="#output-of-preprocessing"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ms_preprocessed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">feature_name</span>   <span class="op">&lt;-</span> </span>
<span>  <span class="fu">xcms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">featureDefinitions</a></span><span class="op">(</span><span class="va">ms_preprocessed</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>feature_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"M"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mzmed</span><span class="op">)</span>, <span class="st">"T"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rtmed</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         feature_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/make.unique.html" class="external-link">make.unique</a></span><span class="op">(</span><span class="va">feature_name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">feature_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_values</span>  <span class="op">&lt;-</span> </span>
<span>  <span class="fu">xcms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html" class="external-link">featureValues</a></span><span class="op">(</span><span class="va">ms_preprocessed</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>feature_name <span class="op">=</span> <span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">feature_name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">feature_name</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="id_-clean-all-intermediate-files"># clean all intermediate files<a class="anchor" aria-label="anchor" href="#id_-clean-all-intermediate-files"></a>
</h1>
</div>
<div class="section level1">
<h1 id="unlinktmp-recursive--true">unlink(“tmp”, recursive = TRUE)<a class="anchor" aria-label="anchor" href="#unlinktmp-recursive--true"></a>
</h1>
</div>
<div class="section level1">
<h1 id="section">```<a class="anchor" aria-label="anchor" href="#section"></a>
</h1>
</div>

  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cXCMS</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>The package maintainer <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
