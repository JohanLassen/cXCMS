<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>HPC workflow • cXCMS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="HPC workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cXCMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/HPC_workflow.html">HPC workflow</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial.html">Tutorial</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>HPC workflow</h1>
            
      

      <div class="d-none name"><code>HPC_workflow.Rmd</code></div>
    </div>

    
    
<p>The goal of cXCMS is to provide the framework for efficient high
performance computing (HPC) untargeted LCMS data pre-processing. Also,
the package memory optimizes the workflow in laptops environments (MacOS
or Windows), allowing preprocessing of larger sample sizes on small PCs.
The source code has been used for the project <a href="%5Chttps://doi.org/10.1111/acel.13813" class="external-link">Large-Scale metabolomics:
Predicting biological age using 10,133 routine untargeted LC-MS
measurements</a>.</p>
<div class="section level2">
<h2 id="hcp-introduction">HCP Introduction<a class="anchor" aria-label="anchor" href="#hcp-introduction"></a>
</h2>
<p>This tutorial is meant for high performance computing users on linux
systems. The tutorial walks through the following parts:</p>
<ul>
<li>Prerequisites</li>
<li>Installation</li>
<li>Workflow Setup</li>
<li>Run workflow</li>
<li>Details</li>
</ul>
<div class="section level4">
<h4 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h4>
<p>Before starting make sure you have <a href="https://conda.io/projects/conda/en/latest/user-guide/install/index.html" class="external-link">anaconda</a>
and <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git" class="external-link">git</a>
installed.</p>
<p>Currently, the workflow is based on <a href="https://gwf.app/" class="external-link">gwf</a> and has been tested on Slurm although
SGE and LSF also should work. We invite snakemake users to push a
workflow as well.</p>
<p>Finally, it is important you have the data available as mzML
files.</p>
</div>
<div class="section level4">
<h4 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h4>
<p>Open the terminal and navigate to your project directory:</p>
<pre><code>cd ~/home/users/path/to/experiment/</code></pre>
<p>Download the workflow from github</p>
<pre><code>git clone http://github.com/JohanLassen/xcms_workflow</code></pre>
<p>Navigate to the workflow folder</p>
<pre><code>cd xcms_workflow</code></pre>
<p>Now you should install the dependencies using conda. This might take
some time.</p>
<pre><code>conda env create -n xcms_workflow -f environment.yml</code></pre>
<p>Activate the conda environment</p>
<pre><code>conda activate xcms_workflow</code></pre>
</div>
<div class="section level4">
<h4 id="workflow-setup">Workflow Setup<a class="anchor" aria-label="anchor" href="#workflow-setup"></a>
</h4>
<p>Before running the workflow, edit the setup.yaml file. The setup file
has two categories of parameters:</p>
<ol style="list-style-type: decimal">
<li>Those making the code work</li>
</ol>
<ul>
<li><p>run_id (needed): Identifier of your run. Smart if both positive
and negative ionization must be run. Will be used to name submitted
jobs.</p></li>
<li><p>input_path (needed): The absolute path to the input data.
Subdirectories are allowed and will be included in the file identifier
in the output. E.g., the data directory could be ./data/positive and
contain the subdirectories ./data/positive/batch1 and
./data/positive/batch2</p></li>
<li><p>output_path (strongly recommended): The output directory. If it
does not exist the workflow will generate it automatically.</p></li>
<li><p>sample_overview_path (optional): Currently on experimental stage.
Used for defining groups of the samples. The file must be semicolon
separated with a column named “sample_group” and a column named
“sample_name”. The sample_names must be (at least) unique substrings of
the filenames, e.g., for file ./datafolder/sample_id_123.mzML the
sample_name “sample_id_123” is sufficient.</p></li>
<li><p>CAMERA_RULES (optional): path to the adduct annotation rules
(CAMERA R package). Default ones are included in the workflow.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Those improving your xcms results:</li>
</ol>
<ul>
<li>As indicated the workflow does peak picking → grouping → alignment →
grouping and finally integration of missing peaks. The parameters of
each step must be set accordingly to the experiment.</li>
</ul>
<p>Natively it looks like this and is meant for positive ionization
data, see parameter descriptions below:</p>
<pre><code><span><span class="va">general</span><span class="op">:</span></span>
<span>  <span class="va">run_id</span><span class="op">:</span> <span class="va">run1</span></span>
<span>  <span class="va">input_path</span><span class="op">:</span> <span class="va">.</span><span class="op">/</span><span class="va">data</span><span class="op">/</span></span>
<span>  <span class="va">output_path</span><span class="op">:</span> <span class="va">.</span><span class="op">/</span><span class="va">experiment_results</span><span class="op">/</span></span>
<span>  <span class="va">sample_overview_path</span><span class="op">:</span> <span class="va">.</span><span class="op">/</span><span class="va">overview_pos.csv</span></span>
<span>  <span class="va">CAMERA_RULES</span><span class="op">:</span> <span class="va">.</span><span class="op">/</span><span class="va">camera_rules</span><span class="op">/</span><span class="va">rules_pos.csv</span></span>
<span><span class="va">xcms_parameters</span><span class="op">:</span></span>
<span>  <span class="va">centwave</span><span class="op">:</span></span>
<span>    <span class="va">mzdiff</span><span class="op">:</span> <span class="fl">0.01</span></span>
<span>    <span class="va">peakwidth</span><span class="op">:</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">25</span><span class="op">)</span></span>
<span>    <span class="va">ppm</span><span class="op">:</span> <span class="fl">12</span></span>
<span>    <span class="va">prefilter</span><span class="op">:</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">snthresh</span><span class="op">:</span> <span class="fl">6</span></span>
<span>  <span class="va">peak_grouping1</span><span class="op">:</span></span>
<span>    <span class="va">binSize</span><span class="op">:</span> <span class="fl">0.01</span></span>
<span>    <span class="va">bw</span><span class="op">:</span> <span class="fl">2.5</span></span>
<span>    <span class="va">maxFeatures</span><span class="op">:</span> <span class="fl">50</span></span>
<span>    <span class="va">minFraction</span><span class="op">:</span> <span class="fl">0.3</span></span>
<span>  <span class="va">alignment</span><span class="op">:</span></span>
<span>    <span class="va">extraPeaks</span><span class="op">:</span> <span class="fl">5</span></span>
<span>    <span class="va">family</span><span class="op">:</span> <span class="va">gaussian</span></span>
<span>    <span class="va">minFraction</span><span class="op">:</span> <span class="fl">0.9</span></span>
<span>    <span class="va">smooth</span><span class="op">:</span> <span class="va">loess</span></span>
<span>    <span class="va">span</span><span class="op">:</span> <span class="fl">0.6</span></span>
<span>  <span class="va">peak_grouping2</span><span class="op">:</span></span>
<span>    <span class="va">binSize</span><span class="op">:</span> <span class="fl">0.01</span></span>
<span>    <span class="va">bw</span><span class="op">:</span> <span class="fl">2.5</span></span>
<span>    <span class="va">maxFeatures</span><span class="op">:</span> <span class="fl">50</span></span>
<span>    <span class="va">minFraction</span><span class="op">:</span> <span class="fl">0.6</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="run-the-workflow">Run the workflow<a class="anchor" aria-label="anchor" href="#run-the-workflow"></a>
</h4>
<p>To run the workflow one must initiate gwf (remember to activate the
conda environment). This only has to be done once per workflow
directory.</p>
<pre><code>gwf config set backend slurm</code></pre>
<p>Now you are ready to submit the jobs. Be sure that the setup file is
correct before - the workflow will submit a bunch of jobs (2*number of
files).</p>
<pre><code>gwf run</code></pre>
</div>
<div class="section level4">
<h4 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h4>
<p>The workflow <em>generates a schedule file</em> (.csv file) at the
output directory. The workflow will only do this once per run_id,
meaning that if any of the files are corrupt these can be removed from
the schedule file and the workflow can be resubmitted without
recomputing the already finished parts. If the schedule file is deleted
the next workflow resubmission generates a new one including all
original files.</p>
<p>The workflow saves a <em>copy of the setup file</em>, meaning you
always can recover the settings that the experiment was run under. Just
copy paste the file to the workflow directory to rerun the analysis.</p>
<p>The tmp folder can be deleted after the run, but it might be
beneficial to keep the peak_picked files if more batches are added later
on. Additionally, it is possible to load the temporary files into an
interactive R session if any preprocessed step needs some quality
assurance, plotting, or another output is desired by the user.</p>
<p>The <em>outputs</em> include a feature table with one column
describing the file names (including sub directories separated by
underscores) and the remaining columns representing features. It also
returns a peak table containing adduct annotations. Most xcms users will
be familiar with the formats.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
